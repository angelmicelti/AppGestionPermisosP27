<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1D4ED8">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Gestor Permisos">
    
    <title>Gestor de Asuntos Propios</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tab-active { color: #2563EB; border-bottom: 2px solid #2563EB; background-color: #EFF6FF; }
        .tab-inactive { color: #6B7280; }
        .tab-inactive:hover { background-color: #F9FAFB; }
        
        /* Calendario */
        .calendar-cell { min-height: 4rem; border-top: 1px solid #F3F4F6; border-right: 1px solid #F3F4F6; display: flex; flex-direction: column; align-items: center; justify-content: start; padding-top: 0.25rem; cursor: pointer; position: relative; overflow: hidden; }
        .calendar-cell:hover { background-color: #EFF6FF; }
        
        /* Estados de celda */
        .cell-weekend { background-color: #FEF2F2; cursor: not-allowed; opacity: 0.6; } 
        .cell-local { background-color: #F3E8FF; cursor: not-allowed; } 
        .cell-prov { background-color: #FFEDD5; cursor: not-allowed; } 
        .cell-non-teaching { background-color: #FEF9C3; } 
        .cell-unavailable { background-color: #D1D5DB; cursor: not-allowed; opacity: 0.9; }
        
        .cell-active { box-shadow: inset 0 0 0 1px #3B82F6; }

        /* Loader */
        #app-loader { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tooltip */
        #custom-tooltip {
            position: fixed; z-index: 9999; background-color: rgba(17, 24, 39, 0.95); color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; pointer-events: none;
            display: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-width: 250px;
            white-space: pre-line; line-height: 1.4;
        }
        
        /* Ajustes móviles para inputs */
        input, select, button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col pb-safe">

    <div id="app-loader">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-gray-700">Cargando sistema...</h2>
    </div>

    <div id="custom-tooltip"></div>

    <header class="bg-blue-700 text-white p-4 shadow-md sticky top-0 z-20">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
            <h1 class="text-xl md:text-2xl font-bold flex items-center gap-2 text-center md:text-left">
                <i data-lucide="calendar" class="w-6 h-6 md:w-8 md:h-8"></i>
                <span class="leading-tight">Gestión de Asuntos Propios - IES Virgen de Villadiego</span>
            </h1>
            <div id="auth-status" class="text-xs opacity-90 bg-gray-800 bg-opacity-50 px-3 py-1 rounded-full font-mono whitespace-nowrap">Modo Local</div>
        </div>
    </header>

    <nav class="bg-white shadow-sm sticky top-[60px] md:top-[72px] z-10 overflow-x-auto">
        <div class="max-w-6xl mx-auto flex min-w-full md:min-w-0">
            <button onclick="window.app.switchTab('config')" id="tab-config" class="flex-1 py-3 md:py-4 text-center font-medium transition-colors tab-active text-sm md:text-base whitespace-nowrap px-2">
                <div class="flex justify-center items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> Configuración</div>
            </button>
            <button onclick="window.app.switchTab('calendar')" id="tab-calendar" class="flex-1 py-3 md:py-4 text-center font-medium transition-colors tab-inactive text-sm md:text-base whitespace-nowrap px-2">
                <div class="flex justify-center items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Calendario</div>
            </button>
            <button onclick="window.app.switchTab('stats')" id="tab-stats" class="flex-1 py-3 md:py-4 text-center font-medium transition-colors tab-inactive text-sm md:text-base whitespace-nowrap px-2">
                <div class="flex justify-center items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> Informes</div>
            </button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-3 md:p-6 w-full flex-1 relative flex flex-col mb-4">
        
        <div id="notification-area" class="fixed bottom-4 right-4 z-50 hidden transition-all duration-300 left-4 md:left-auto text-center md:text-right">
            <div id="notification-msg" class="px-6 py-3 rounded-lg shadow-lg text-white font-medium inline-block w-full md:w-auto"></div>
        </div>

        <div id="view-config" class="space-y-6 fade-in pb-10">
            
            <div class="flex justify-end">
                <button onclick="window.app.openHelpModal()" class="flex items-center gap-2 text-blue-700 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-full font-medium transition shadow-sm border border-blue-200 text-sm w-full md:w-auto justify-center">
                    <i data-lucide="help-circle" class="w-5 h-5"></i> ¿Cómo funciona?
                </button>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-100">
                <h2 class="text-lg md:text-xl font-bold mb-4 text-blue-800 border-b pb-2">1. Datos del Curso</h2>
                <div class="flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-4 flex-wrap">
                    <label class="font-medium">Año de inicio (Septiembre):</label>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <input type="number" id="input-start-year" class="border p-2 rounded w-full md:w-32 focus:ring-2 focus:ring-blue-500 outline-none" onchange="window.app.updateConfig('year')">
                        <span class="text-gray-500 text-sm whitespace-nowrap" id="text-end-year">→ Fin: ...</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-100 border-l-4 border-l-gray-800 transition-all duration-300">
                <h2 class="text-lg md:text-xl font-bold mb-0 text-gray-800 border-b pb-2 flex items-center gap-2 cursor-pointer select-none" onclick="window.app.toggleGithubConfig()">
                    <i data-lucide="github" class="w-5 h-5"></i> Configuración Nube
                    <i id="github-chevron" data-lucide="chevron-up" class="w-4 h-4 ml-auto transition-transform duration-300"></i>
                </h2>
                <div id="github-config-content" class="flex flex-col gap-4 mt-4 transition-all duration-300 overflow-hidden">
                    <p class="text-sm text-gray-600">
                        Introduce tu <strong>Personal Access Token</strong> de GitHub (permiso <code>gist</code>).
                    </p>
                    <div class="flex flex-col md:flex-row gap-2 items-stretch md:items-center">
                        <input type="password" id="input-github-token" placeholder="ghp_xxxxxxxxxxxx..." class="flex-1 border p-2 rounded focus:ring-2 focus:ring-gray-500 outline-none text-sm font-mono">
                        <button onclick="window.app.saveGithubToken()" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900 transition text-sm font-bold">
                            Validar
                        </button>
                    </div>
                    <div id="github-msg" class="text-xs font-bold text-gray-400">Token no configurado.</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-100 flex flex-col h-full">
                    <h2 class="text-lg md:text-xl font-bold mb-4 text-blue-800 border-b pb-2">2. Profesorado</h2>
                    <form onsubmit="window.app.addTeacherManual(event)" class="flex gap-2 mb-4">
                        <input type="text" id="input-new-teacher" placeholder="Nombre manual..." class="flex-1 border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 px-4"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </form>
                    <div class="mb-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <div class="flex items-center gap-2 mb-2 text-blue-800 font-medium"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i><span>Importar Excel</span></div>
                        <label class="cursor-pointer bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 transition w-full py-2 px-3 rounded flex items-center justify-center gap-2 text-sm font-medium shadow-sm active:bg-blue-100">
                            <i data-lucide="upload" class="w-4 h-4"></i> Seleccionar archivo
                            <input type="file" accept=".xlsx, .xls" class="hidden" onchange="window.app.handleExcelUpload(event)">
                        </label>
                    </div>
                    <div class="flex-1 overflow-hidden flex flex-col min-h-[150px]">
                        <span id="teacher-count" class="text-xs text-gray-400 mb-1 uppercase tracking-wider font-bold">Listado (0)</span>
                        <ul id="list-teachers" class="flex-1 overflow-y-auto space-y-2 border-t pt-2 max-h-60"></ul>
                    </div>
                </div>

                <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-100 flex flex-col gap-4">
                    <div>
                        <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                            <h2 class="text-lg md:text-xl font-bold text-blue-800">3. Festivos Locales</h2>
                            <div class="flex gap-2 items-center ml-auto">
                                <button onclick="window.app.clearHolidays('local')" class="text-xs text-red-500 hover:text-red-700 underline font-medium mr-1">Borrar</button>
                                <button onclick="window.app.openDateModal('local')" class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200 shadow-sm">+ Añadir</button>
                            </div>
                        </div>
                        <div id="list-local-holidays" class="flex flex-wrap gap-2 min-h-[2rem]"></div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                            <h2 class="text-lg md:text-xl font-bold text-blue-800">4. Festivos Provinciales/Nacionales</h2>
                            <div class="flex gap-2 items-center ml-auto">
                                <button onclick="window.app.clearHolidays('provincial')" class="text-xs text-red-500 hover:text-red-700 underline font-medium mr-1">Borrar</button>
                                <button onclick="window.app.openDateModal('provincial')" class="text-sm bg-orange-100 text-orange-700 px-3 py-1 rounded hover:bg-orange-200 shadow-sm">+ Añadir</button>
                            </div>
                        </div>
                        <div id="list-prov-holidays" class="flex flex-wrap gap-2 min-h-[2rem]"></div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                            <h2 class="text-lg md:text-xl font-bold text-blue-800">5. Días No Lectivos</h2>
                            <div class="flex gap-2 items-center ml-auto">
                                <button onclick="window.app.clearHolidays('nonTeaching')" class="text-xs text-red-500 hover:text-red-700 underline font-medium mr-1">Borrar</button>
                                <button onclick="window.app.openDateModal('nonTeaching')" class="text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded hover:bg-yellow-200 shadow-sm">+ Tramo</button>
                            </div>
                        </div>
                        <div id="list-non-teaching-days" class="flex flex-wrap gap-2 min-h-[2rem]"></div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                            <h2 class="text-lg md:text-xl font-bold text-blue-800">6. Días No Disponibles</h2>
                            <div class="flex gap-2 items-center ml-auto">
                                <button onclick="window.app.clearHolidays('unavailable')" class="text-xs text-red-500 hover:text-red-700 underline font-medium mr-1">Borrar</button>
                                <button onclick="window.app.openDateModal('unavailable')" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 shadow-sm">+ Añadir</button>
                            </div>
                        </div>
                        <div id="list-unavailable-days" class="flex flex-wrap gap-2 min-h-[2rem]"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-red-100">
                <h2 class="text-lg md:text-xl font-bold mb-0 text-red-800 border-b border-red-100 pb-2 flex items-center gap-2 cursor-pointer select-none" onclick="window.app.toggleDeleteConfig()">
                    <i data-lucide="trash-2" class="w-5 h-5"></i> 7. Eliminar Permisos Almacenados
                    <i id="delete-chevron" data-lucide="chevron-up" class="w-4 h-4 ml-auto transition-transform duration-300" style="transform: rotate(180deg);"></i>
                </h2>
                <div id="delete-config-content" class="mt-4 transition-all duration-300 overflow-hidden hidden" style="height: 0px;">
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-sm text-red-900 mb-3 font-medium">Selecciona los tipos de permisos que deseas eliminar definitivamente:</p>
                        <div class="flex flex-col sm:flex-row flex-wrap gap-3 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-3 rounded border border-red-200 shadow-sm active:bg-gray-50">
                                <input type="checkbox" id="del-type-paid-teaching" class="w-5 h-5 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <span class="text-sm text-gray-700">Retribuidos Lectivos</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-3 rounded border border-red-200 shadow-sm active:bg-gray-50">
                                <input type="checkbox" id="del-type-paid-non-teaching" class="w-5 h-5 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <span class="text-sm text-gray-700">Retribuidos No Lectivos</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-3 rounded border border-red-200 shadow-sm active:bg-gray-50">
                                <input type="checkbox" id="del-type-unpaid" class="w-5 h-5 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <span class="text-sm text-gray-700">No Retribuidos</span>
                            </label>
                        </div>
                        <button onclick="window.app.bulkDeleteRequests()" class="w-full sm:w-auto bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 transition text-sm font-bold flex items-center justify-center gap-2 shadow active:scale-95">
                            <i data-lucide="trash" class="w-4 h-4"></i> Eliminar seleccionados
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-calendar" class="space-y-8 fade-in hidden">
            <div class="flex gap-3 items-center justify-center text-xs md:text-sm mb-4 bg-white p-3 rounded shadow-sm flex-wrap">
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border"><div class="w-3 h-3 bg-red-100 rounded"></div> Finde/Festivo</div>
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border"><div class="w-3 h-3 bg-purple-200 rounded"></div> F. Local</div>
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border"><div class="w-3 h-3 bg-orange-200 rounded"></div> F. Prov</div>
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border"><div class="w-3 h-3 bg-yellow-100 border border-yellow-300 rounded"></div> No Lect</div>
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border"><div class="w-3 h-3 bg-gray-300 rounded"></div> No Dispon.</div>
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border font-bold"><div class="w-3 h-3 border-2 border-blue-500 rounded"></div> Solicitud</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
        </div>

        <div id="view-stats" class="space-y-8 fade-in hidden">
            <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-lg md:text-xl font-bold text-blue-800 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5"></i> Estado del Profesorado</h2>
                    <button onclick="window.app.exportPDF('summary')" class="w-full sm:w-auto text-sm bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 flex items-center justify-center gap-2 shadow-sm"><i data-lucide="file-text" class="w-4 h-4"></i> Exportar PDF</button>
                </div>
                
                <div class="flex flex-wrap items-center gap-4 text-sm mb-4 bg-gray-50 p-3 rounded border border-gray-200">
                    <span class="font-bold text-gray-700 flex items-center gap-1"><i data-lucide="filter" class="w-4 h-4"></i> Mostrar:</span>
                    <label class="flex items-center gap-2 cursor-pointer hover:text-blue-700">
                        <input type="radio" name="filter-summary" value="all" checked onchange="window.app.renderSummaryTable()" class="text-blue-600 focus:ring-blue-500">
                        <span>Todos los profesores</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:text-blue-700">
                        <input type="radio" name="filter-summary" value="active" onchange="window.app.renderSummaryTable()" class="text-blue-600 focus:ring-blue-500">
                        <span class="font-bold">Solo con permisos</span>
                    </label>
                </div>

                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-left border-collapse min-w-[600px]" id="table-summary">
                        <thead><tr class="bg-gray-100 text-gray-600 text-sm uppercase"><th class="p-3 border-b">Profesor</th><th class="p-3 border-b text-center">Retr. Lectivos (2)</th><th class="p-3 border-b text-center">Retr. NO Lect. (4)</th><th class="p-3 border-b text-center">No Retr. (∞)</th><th class="p-3 border-b text-center">Estado</th></tr></thead>
                        <tbody id="table-summary-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow border border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-lg md:text-xl font-bold text-blue-800 flex items-center gap-2"><i data-lucide="file-text" class="w-5 h-5"></i> Informe Detallado</h2>
                    <button onclick="window.app.exportPDF('report')" class="w-full sm:w-auto text-sm bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 flex items-center justify-center gap-2 shadow-sm"><i data-lucide="file-text" class="w-4 h-4"></i> Exportar PDF</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mb-6 items-end bg-gray-50 p-4 rounded flex-wrap border border-gray-200">
                    <div class="w-full sm:w-auto"><label class="block text-sm text-gray-600 mb-1">Desde:</label><input type="date" id="report-start" class="border p-2 rounded w-full" onchange="window.app.renderReportTable()"></div>
                    <div class="w-full sm:w-auto"><label class="block text-sm text-gray-600 mb-1">Hasta:</label><input type="date" id="report-end" class="border p-2 rounded w-full" onchange="window.app.renderReportTable()"></div>
                    <div class="text-sm text-gray-500 pb-2 w-full sm:flex-1 sm:text-right">Resultados: <span id="report-count" class="font-bold">0</span></div>
                </div>
                <div class="overflow-x-auto rounded border border-gray-200">
                    <table class="w-full text-left min-w-[500px]" id="table-report">
                        <thead><tr class="bg-blue-50 text-blue-800 text-sm"><th class="p-3 border-b">Fecha</th><th class="p-3 border-b">Profesor</th><th class="p-3 border-b">Tipo de Permiso</th></tr></thead>
                        <tbody id="table-report-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-3 p-4 bg-white border-t border-gray-200 mt-6 rounded-lg shadow-sm flex-wrap items-center">
            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto md:mr-auto">
                <button onclick="window.app.exportJSON()" class="flex items-center justify-center gap-2 bg-purple-600 text-white px-4 py-3 rounded hover:bg-purple-700 transition text-sm w-full sm:w-auto shadow-sm active:bg-purple-800">
                    <i data-lucide="download" class="w-4 h-4"></i> Exportar JSON
                </button>
                <label class="flex items-center justify-center gap-2 bg-purple-800 text-white px-4 py-3 rounded hover:bg-purple-900 transition cursor-pointer text-sm w-full sm:w-auto shadow-sm active:bg-purple-950">
                    <i data-lucide="upload" class="w-4 h-4"></i> Importar JSON
                    <input type="file" accept=".json" class="hidden" onchange="window.app.importJSON(event)">
                </label>
            </div>
            
            <div class="w-full h-px bg-gray-200 md:w-px md:h-10 md:bg-gray-300 md:mx-2 hidden md:block"></div>
            
            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                <button onclick="window.app.saveLocal()" class="flex items-center justify-center gap-2 bg-gray-600 text-white px-5 py-3 rounded hover:bg-gray-700 transition text-sm w-full sm:w-auto shadow-sm active:bg-gray-800">
                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Local
                </button>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="window.app.saveGitHub()" class="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-gray-800 text-white px-5 py-3 rounded hover:bg-gray-900 transition text-sm shadow-sm active:bg-black">
                        <i data-lucide="cloud" class="w-4 h-4"></i> Guardar Nube
                    </button>
                    <button onclick="window.app.loadGitHub()" class="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-gray-700 text-white px-5 py-3 rounded hover:bg-gray-600 transition text-sm shadow-sm active:bg-gray-800">
                        <i data-lucide="download-cloud" class="w-4 h-4"></i> Cargar Nube
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-holiday" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm max-h-full overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-gray-800" id="modal-holiday-title">Añadir fecha</h3>
            <label class="block text-sm text-gray-600 mb-1" id="label-start-date">Fecha:</label>
            <input type="date" id="input-holiday-date" class="w-full border p-3 rounded mb-4 text-base bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none">
            <div id="container-end-date" class="hidden">
                <label class="block text-sm text-gray-600 mb-1">Fecha Fin (Tramo):</label>
                <input type="date" id="input-holiday-end-date" class="w-full border p-3 rounded mb-4 text-base bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div class="flex justify-end gap-3 pt-2">
                <button onclick="window.app.closeModal('modal-holiday')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-sm font-medium">Cancelar</button>
                <button onclick="window.app.confirmAddHoliday()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow font-medium">Añadir</button>
            </div>
        </div>
    </div>

    <div id="modal-request" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full flex flex-col max-h-[95vh]">
            <div class="bg-blue-700 text-white p-4 flex justify-between items-center shrink-0 rounded-t-xl">
                <h3 class="font-bold text-lg" id="modal-request-title">Gestionar día</h3>
                <button onclick="window.app.closeModal('modal-request')" class="hover:bg-blue-600 p-1 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto">
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Solicitudes activas</h4>
                    <div id="request-list-container" class="space-y-2"></div>
                </div>
                <hr class="my-4 border-gray-100">
                <div>
                    <h4 class="text-sm font-bold text-blue-600 uppercase mb-3">Nueva solicitud</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">Seleccionar Profesor</label>
                            <select id="req-teacher-select" class="w-full border p-3 rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none text-base">
                                <option value="">-- Selecciona --</option>
                            </select>
                        </div>
                        <div class="bg-gray-50 p-3 rounded border border-gray-200">
                            <label class="block text-sm font-bold mb-2 text-gray-700">Tipo de Permiso:</label>
                            <div id="opt-paid-teaching" class="mb-2 p-2 hover:bg-white rounded transition">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="reqType" value="paid_teaching" class="w-5 h-5 text-blue-600">
                                    <span class="text-sm font-medium">Retribuido LECTIVO (Max 2)</span>
                                </label>
                            </div>
                            <div id="opt-paid-non-teaching" class="mb-2 p-2 hover:bg-white rounded transition">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="reqType" value="paid_non_teaching" class="w-5 h-5 text-yellow-600">
                                    <span class="text-sm font-medium">Retribuido NO LECTIVO (Max 4)</span>
                                </label>
                            </div>
                            <div id="opt-unpaid" class="mt-2 pt-2 border-t border-gray-200 p-2 hover:bg-white rounded transition">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="reqType" value="unpaid" class="w-5 h-5 text-gray-600">
                                    <span class="text-sm font-medium">No Retribuido (Sin límite)</span>
                                </label>
                            </div>
                        </div>
                        <button onclick="window.app.submitRequest()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow text-sm md:text-base">Introducir Solicitud</button>
                        
                        <div id="bulk-action-container" class="hidden mt-4 pt-4 border-t border-gray-200">
                            <button onclick="window.app.submitBulkRequest()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition flex items-center justify-center gap-2 shadow text-sm md:text-base">
                                <i data-lucide="users" class="w-5 h-5"></i> Añadir a todo el Claustro
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center px-4">Solo se añadirán los profesores que no hayan superado sus límites.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-github-list" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full flex flex-col max-h-[80vh]">
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center shrink-0 rounded-t-xl">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="cloud" class="w-5 h-5"></i> Copias de seguridad</h3>
                <button onclick="window.app.closeModal('modal-github-list')" class="hover:bg-gray-700 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 bg-gray-50 border-b text-sm text-gray-600">Selecciona la versión a restaurar:</div>
            <div class="p-0 overflow-y-auto flex-1">
                <ul id="github-file-list" class="divide-y divide-gray-200"></ul>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end">
                <button onclick="window.app.closeModal('modal-github-list')" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded text-sm font-medium">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-help" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh]">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="help-circle" class="w-6 h-6"></i> Ayuda Rápida</h3>
                <button onclick="window.app.closeModal('modal-help')" class="hover:bg-blue-500 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto text-gray-700 space-y-5 text-sm leading-relaxed">
                <div>
                    <h4 class="font-bold text-blue-800 text-base mb-2 flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> 1. Configuración</h4>
                    <p>Define el curso, añade profesores y establece los días festivos o no lectivos antes de empezar.</p>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-bold text-blue-800 text-base mb-2 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> 2. Permisos</h4>
                    <p>Toca un día en el calendario. Si es lectivo, permite "Retribuidos Lectivos" o "No Retribuidos". Si es No Lectivo (fondo amarillo), permite "Retribuidos No Lectivos".</p>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-bold text-blue-800 text-base mb-2 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> 3. Límites</h4>
                    <p>Máximo 2 profesores por día. Cada profesor tiene máx. 2 días lectivos retribuidos y 4 no lectivos.</p>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-xl flex justify-end">
                <button onclick="window.app.closeModal('modal-help')" class="px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium transition shadow-sm w-full sm:w-auto">Entendido</button>
            </div>
        </div>
    </div>

    <script type="module">
        window.app = {
            config: { startYear: new Date().getFullYear(), teachers: [], localHolidays: [], provHolidays: [], nonTeachingDays: [], unavailableDays: [] },
            requests: [], 
            tempHolidayType: null,
            selectedDate: null,
            githubToken: localStorage.getItem('githubToken') || ''
        };

        async function init() {
            try {
                const lc = localStorage.getItem('schoolConfig');
                const lr = localStorage.getItem('schoolRequests');
                if (lc) window.app.config = { ...window.app.config, ...JSON.parse(lc) };
                if (lr) window.app.requests = JSON.parse(lr);
                window.app.config.teachers.sort((a,b) => a.name.localeCompare(b.name));
                if(window.app.githubToken) document.getElementById('input-github-token').value = window.app.githubToken;
                renderAll();
            } catch (err) { console.error(err); } 
            finally {
                const loader = document.getElementById('app-loader');
                if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
                lucide.createIcons();
            }
        }

        function updateAuthStatus(isConnected, userLogin) {
            const el = document.getElementById('auth-status');
            const msgEl = document.getElementById('github-msg');
            if(isConnected) {
                el.innerText = `Conectado (${userLogin})`; el.classList.replace('bg-gray-800', 'bg-green-600');
                msgEl.innerText = `Token válido. Usuario: ${userLogin}`; msgEl.classList.replace('text-gray-400', 'text-green-600');
                msgEl.classList.remove('text-red-500');
            } else {
                el.innerText = 'Modo Local'; el.classList.replace('bg-green-600', 'bg-gray-800');
                msgEl.innerText = userLogin || 'Error en token.'; msgEl.classList.remove('text-green-600', 'text-gray-400');
                msgEl.classList.add('text-red-500');
            }
        }

        const GIST_FILENAME = 'gestor_permisos_data.json';
        const GIST_DESC = 'Gestor de Permisos Escolar - Datos';

        window.app.toggleGithubConfig = () => {
            const content = document.getElementById('github-config-content');
            const chevron = document.getElementById('github-chevron');
            if (content.style.height === '0px' || content.classList.contains('hidden')) {
                content.classList.remove('hidden'); content.style.height = 'auto';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                content.style.height = '0px'; content.classList.add('hidden');
                chevron.style.transform = 'rotate(180deg)';
            }
        };

        window.app.toggleDeleteConfig = () => {
            const content = document.getElementById('delete-config-content');
            const chevron = document.getElementById('delete-chevron');
            
            if (content.style.height === '0px' || content.classList.contains('hidden')) {
                content.classList.remove('hidden'); 
                content.style.height = 'auto';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                content.style.height = '0px'; 
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(180deg)';
            }
        };

        window.app.saveGithubToken = async () => {
            const t = document.getElementById('input-github-token').value.trim();
            if(!t) return alert("Introduce un token válido");
            showNotification('Validando token...', 'info');
            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${t}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if(!res.ok) throw new Error("Token inválido o sin permisos");
                const user = await res.json();
                window.app.githubToken = t;
                localStorage.setItem('githubToken', t);
                updateAuthStatus(true, user.login);
                showNotification(`Conectado como ${user.login}`);
                window.app.toggleGithubConfig(); 
            } catch(e) {
                console.error(e);
                updateAuthStatus(false, "Token inválido");
                showNotification("Error: El token no funciona", 'error');
            }
        };

        window.app.saveGitHub = async () => {
            if(!window.app.githubToken) {
                window.app.switchTab('config');
                document.getElementById('input-github-token').focus();
                return alert("Primero configura y valida tu Token de GitHub.");
            }
            const userDesc = prompt("Nombre para esta copia de seguridad (opcional):", "Copia manual");
            if (userDesc === null) return; 

            try {
                showNotification('Conectando con GitHub...', 'info');
                const content = JSON.stringify({ config: window.app.config, requests: window.app.requests }, null, 2);
                const headers = { 'Authorization': `token ${window.app.githubToken}`, 'Accept': 'application/vnd.github.v3+json' };
                const finalDesc = userDesc.trim() ? `${GIST_DESC} - ${userDesc}` : `${GIST_DESC} - ${new Date().toLocaleString()}`;

                const body = { description: finalDesc, public: false, files: { [GIST_FILENAME]: { content: content } } };
                const resp = await fetch('https://api.github.com/gists', { method: 'POST', headers, body: JSON.stringify(body) });
                if(!resp.ok) throw new Error(`Error al guardar: ${resp.status}`);
                showNotification('¡Datos guardados en GitHub correctamente!');
            } catch (e) { console.error(e); showNotification(e.message, 'error'); }
        };

        window.app.loadGitHub = async () => {
            if(!window.app.githubToken) return alert("Configura tu Token primero.");
            try {
                showNotification('Consultando GitHub...', 'info');
                const headers = { 'Authorization': `token ${window.app.githubToken}`, 'Accept': 'application/vnd.github.v3+json' };
                // Añadimos un timestamp para evitar cacheo del navegador
                const listResp = await fetch(`https://api.github.com/gists?t=${Date.now()}`, { 
                    headers,
                    cache: "no-store" 
                });
                if(!listResp.ok) throw new Error('Error al conectar con GitHub.');
                const gists = await listResp.json();
                const relevantGists = gists.filter(g => (g.files && g.files[GIST_FILENAME]) || (g.description && g.description.includes('Gestor de Permisos')));
                if (relevantGists.length === 0) throw new Error('No se encontraron copias de seguridad.');
                window.app.renderGistList(relevantGists);
                document.getElementById('modal-github-list').classList.remove('hidden');
            } catch (e) { console.error(e); showNotification(e.message, 'error'); }
        };

        window.app.deleteGist = async (gistId) => {
            if(!confirm("¿Estás seguro de que deseas ELIMINAR permanentemente esta copia de seguridad de GitHub?")) return;
            
            showNotification('Eliminando...', 'info');
            try {
                const headers = { 'Authorization': `token ${window.app.githubToken}`, 'Accept': 'application/vnd.github.v3+json' };
                const resp = await fetch(`https://api.github.com/gists/${gistId}`, { method: 'DELETE', headers });
                
                if (resp.status === 204) {
                    showNotification('Copia eliminada correctamente.');
                    window.app.loadGitHub(); 
                } else {
                    const txt = await resp.text();
                    throw new Error(`Error al eliminar (${resp.status}): ${txt}`);
                }
            } catch (e) {
                console.error(e);
                showNotification(e.message, 'error');
            }
        };

        window.app.renderGistList = (gists) => {
            const container = document.getElementById('github-file-list');
            container.innerHTML = '';
            gists.forEach(gist => {
                const date = new Date(gist.updated_at).toLocaleString();
                let desc = gist.description || '(Sin descripción)';
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-4 hover:bg-gray-50 transition group border-b last:border-0';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'cursor-pointer flex-1 mr-4';
                contentDiv.onclick = () => window.app.loadSpecificGist(gist.id);
                contentDiv.innerHTML = `
                    <div class="font-bold text-gray-800 group-hover:text-blue-700 text-sm md:text-base">${desc}</div>
                    <div class="text-xs text-gray-500 mt-1 flex items-center gap-2"><i data-lucide="clock" class="w-3 h-3"></i> ${date}</div>
                `;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex items-center gap-3';

                const loadBtn = document.createElement('button');
                loadBtn.className = 'text-gray-400 hover:text-blue-600 transition';
                loadBtn.onclick = () => window.app.loadSpecificGist(gist.id);
                loadBtn.innerHTML = '<i data-lucide="download-cloud" class="w-5 h-5"></i>';

                const delBtn = document.createElement('button');
                delBtn.className = 'text-gray-400 hover:text-red-600 transition p-1';
                delBtn.onclick = (e) => { e.stopPropagation(); window.app.deleteGist(gist.id); };
                delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';

                actionsDiv.appendChild(loadBtn);
                actionsDiv.appendChild(delBtn);

                li.appendChild(contentDiv);
                li.appendChild(actionsDiv);
                container.appendChild(li);
            });
            lucide.createIcons();
        };

        window.app.loadSpecificGist = async (gistId) => {
            window.app.closeModal('modal-github-list');
            showNotification('Descargando...', 'info');
            try {
                const headers = { 'Authorization': `token ${window.app.githubToken}`, 'Accept': 'application/vnd.github.v3+json' };
                const gistResp = await fetch(`https://api.github.com/gists/${gistId}`, { headers });
                if(!gistResp.ok) throw new Error('Error al descargar.');
                const fullGist = await gistResp.json();
                const targetFile = fullGist.files[GIST_FILENAME];
                if (!targetFile) throw new Error(`Archivo no encontrado en el Gist.`);
                const data = JSON.parse(targetFile.content);
                if(data.config && data.requests) {
                    window.app.config = data.config;
                    window.app.requests = data.requests;
                    window.app.config.teachers.sort((a,b) => a.name.localeCompare(b.name));
                    renderAll(); renderCalendar(); 
                    window.app.renderSummaryTable();
                    window.app.saveLocal();
                    showNotification('¡Copia restaurada!');
                } else { throw new Error('Formato incorrecto.'); }
            } catch (e) { console.error(e); showNotification(e.message, 'error'); }
        };

        window.app.switchTab = (tabName) => {
            ['config', 'calendar', 'stats'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const view = document.getElementById(`view-${t}`);
                if (t === tabName) { btn.classList.replace('tab-inactive', 'tab-active'); view.classList.remove('hidden'); } 
                else { btn.classList.replace('tab-active', 'tab-inactive'); view.classList.add('hidden'); }
            });
            if (tabName === 'calendar') renderCalendar();
            if (tabName === 'stats') { window.app.renderSummaryTable(); window.app.renderReportTable(); }
        };

        window.app.openHelpModal = () => { document.getElementById('modal-help').classList.remove('hidden'); lucide.createIcons(); };

        function showNotification(msg, type = 'success') {
            const area = document.getElementById('notification-area');
            const box = document.getElementById('notification-msg');
            box.textContent = msg;
            let color = 'bg-green-600';
            if(type === 'error') color = 'bg-red-500';
            if(type === 'info') color = 'bg-blue-600';
            box.className = `px-6 py-3 rounded-lg shadow-lg text-white font-medium ${color} w-full md:w-auto`;
            area.classList.remove('hidden');
            setTimeout(() => area.classList.add('hidden'), 3000);
        }
        window.app.showNotification = showNotification;

        window.app.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.app.showTooltip = (e, htmlContent) => {
            if(window.innerWidth < 768) return; // No tooltip on mobile
            const tooltip = document.getElementById('custom-tooltip');
            tooltip.innerHTML = htmlContent;
            tooltip.style.display = 'block';
            const x = e.clientX + 10; const y = e.clientY + 10;
            tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
        };
        window.app.hideTooltip = () => { document.getElementById('custom-tooltip').style.display = 'none'; };

        window.app.exportPDF = (type) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const ts = String(now.getDate()).padStart(2,'0') + String(now.getMonth()+1).padStart(2,'0') + String(now.getFullYear()).slice(-2) + "_" + String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');
            
            if (type === 'summary') {
                const filter = document.querySelector('input[name="filter-summary"]:checked').value;
                const subTitle = filter === 'active' ? '(Solo con permisos)' : '(Todos)';
                
                doc.text(`Asuntos propios - Estado del profesorado ${subTitle}`, 14, 15);
                doc.text(`Fecha: ${dateStr}`, 14, 22);
                doc.autoTable({ html: '#table-summary', startY: 25 });
                doc.save(`EstadoProfesorado_${ts}.pdf`);
            } else {
                const s = document.getElementById('report-start').value;
                const e = document.getElementById('report-end').value;
                
                const fmt = (d) => {
                    if(!d) return '';
                    const [y, m, da] = d.split('-');
                    return `${da}/${m}/${y}`;
                };

                const range = s && e ? ` (${fmt(s)} a ${fmt(e)})` : '';
                doc.text(`Informe Detallado${range}`, 14, 15);
                doc.autoTable({ html: '#table-report', startY: 20 });
                doc.save(`InformeDetallado_${ts}.pdf`);
            }
            showNotification('PDF Generado');
        };

        window.app.exportJSON = () => {
            const data = { config: window.app.config, requests: window.app.requests };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const filename = `DatosPermisosAAPP_IES_${window.app.config.startYear}.json`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        window.app.importJSON = async (e) => {
            const file = e.target.files[0]; if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                if (data.config && data.requests) {
                    window.app.config = data.config; window.app.requests = data.requests;
                    window.app.config.teachers.sort((a,b) => a.name.localeCompare(b.name)); 
                    renderAll(); renderCalendar(); window.app.saveLocal(); showNotification('Datos importados');
                }
            } catch (err) { showNotification('Error JSON', 'error'); }
            e.target.value = ''; 
        };

        window.app.saveLocal = () => {
            localStorage.setItem('schoolConfig', JSON.stringify(window.app.config));
            localStorage.setItem('schoolRequests', JSON.stringify(window.app.requests));
            showNotification('Datos guardados en Local');
        };

        window.app.handleExcelUpload = async (e) => {
            const file = e.target.files[0]; if(!file) return;
            try {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type:'array'});
                const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                let added = 0; const existing = new Set(window.app.config.teachers.map(t => t.name.toLowerCase()));
                jsonData.forEach(row => {
                    if(row && row[0]) {
                        const val = String(row[0]).trim();
                        if(!['nombre','profesor'].includes(val.toLowerCase()) && val.length > 2 && !existing.has(val.toLowerCase())) {
                            window.app.config.teachers.push({ id: crypto.randomUUID(), name: val });
                            existing.add(val.toLowerCase()); added++;
                        }
                    }
                });
                if(added>0) { window.app.config.teachers.sort((a,b) => a.name.localeCompare(b.name)); renderAll(); showNotification(`Importados ${added}`); }
            } catch(err) { showNotification('Error Excel', 'error'); }
            e.target.value = '';
        };

        function renderAll() {
            document.getElementById('input-start-year').value = window.app.config.startYear;
            document.getElementById('text-end-year').innerText = `→ Fin: ${window.app.config.startYear + 1}`;
            const listT = document.getElementById('list-teachers'); listT.innerHTML = '';
            document.getElementById('teacher-count').innerText = `Listado (${window.app.config.teachers.length})`;
            window.app.config.teachers.forEach(t => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm hover:bg-gray-100';
                li.innerHTML = `<span>${t.name}</span> <button onclick="window.app.removeTeacher('${t.id}')" class="text-red-400 hover:text-red-600 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                listT.appendChild(li);
            });
            renderHolidayList('local', 'list-local-holidays');
            renderHolidayList('provincial', 'list-prov-holidays');
            renderHolidayList('nonTeaching', 'list-non-teaching-days');
            renderHolidayList('unavailable', 'list-unavailable-days');
            lucide.createIcons();
        }

        function renderHolidayList(type, containerId) {
            const container = document.getElementById(containerId);
            let list = []; let colorClass = '';
            if (type === 'local') { list = window.app.config.localHolidays; colorClass = 'bg-purple-100 text-purple-800'; }
            else if (type === 'provincial') { list = window.app.config.provHolidays; colorClass = 'bg-orange-100 text-orange-800'; }
            else if (type === 'nonTeaching') { list = window.app.config.nonTeachingDays || []; colorClass = 'bg-yellow-100 text-yellow-800'; }
            else if (type === 'unavailable') { list = window.app.config.unavailableDays || []; colorClass = 'bg-gray-200 text-gray-800'; }
            container.innerHTML = '';
            if(list.length === 0) { container.innerHTML = '<span class="text-gray-400 text-sm">Ninguno</span>'; return; }
            list.forEach(date => {
                const span = document.createElement('span');
                span.className = `${colorClass} px-2 py-1 rounded text-sm flex items-center gap-1`;
                span.innerHTML = `${new Date(date).toLocaleDateString()} <i data-lucide="x" class="w-4 h-4 cursor-pointer p-0.5" onclick="window.app.removeHoliday('${type}', '${date}')"></i>`;
                container.appendChild(span);
            });
        }

        window.app.updateConfig = (key) => { if(key === 'year') { window.app.config.startYear = parseInt(document.getElementById('input-start-year').value); renderAll(); }};
        window.app.addTeacherManual = (e) => { 
            e.preventDefault(); 
            const n = document.getElementById('input-new-teacher').value.trim(); 
            if(n){ 
                window.app.config.teachers.push({id:crypto.randomUUID(), name:n}); 
                window.app.config.teachers.sort((a,b)=>a.name.localeCompare(b.name));
                document.getElementById('input-new-teacher').value=''; 
                renderAll(); 
            }
        };
        window.app.removeTeacher = (id) => { 
            const t = window.app.config.teachers.find(teacher => teacher.id === id);
            if(confirm(`¿Eliminar al profesor ${t ? t.name : ''}?`)) {
                window.app.config.teachers = window.app.config.teachers.filter(t => t.id !== id); 
                renderAll(); 
            }
        };
        
        window.app.openDateModal = (type) => { window.app.tempHolidayType = type; document.getElementById('modal-holiday').classList.remove('hidden'); document.getElementById('container-end-date').classList.toggle('hidden', type !== 'nonTeaching'); };
        
        window.app.removeHoliday = (type, date) => { 
            let typeName = "";
            if(type === 'local') typeName = "festivo local";
            else if(type === 'provincial') typeName = "festivo provincial/nacional";
            else if(type === 'nonTeaching') typeName = "día no lectivo";
            else if(type === 'unavailable') typeName = "día no disponible";
            
            if(confirm(`¿Eliminar el ${typeName} del ${new Date(date).toLocaleDateString()}?`)) {
                const target = type==='local'?'localHolidays':(type==='provincial'?'provHolidays':(type==='unavailable'?'unavailableDays':'nonTeachingDays')); 
                window.app.config[target] = window.app.config[target].filter(d => d !== date); 
                renderAll(); 
            }
        };
        
        window.app.clearHolidays = (type) => {
            const map = { local: 'localHolidays', provincial: 'provHolidays', nonTeaching: 'nonTeachingDays', unavailable: 'unavailableDays' };
            const label = { local: 'festivos locales', provincial: 'festivos provinciales', nonTeaching: 'días no lectivos', unavailable: 'días no disponibles' };
            if(confirm(`¿Borrar TODOS los ${label[type]}?`)) { window.app.config[map[type]] = []; renderAll(); renderCalendar(); showNotification(`Eliminados ${label[type]}`); }
        };

        window.app.bulkDeleteRequests = () => {
            const cbPaidTeaching = document.getElementById('del-type-paid-teaching');
            const cbPaidNonTeaching = document.getElementById('del-type-paid-non-teaching');
            const cbUnpaid = document.getElementById('del-type-unpaid');

            const pt = cbPaidTeaching.checked;
            const pnt = cbPaidNonTeaching.checked;
            const u = cbUnpaid.checked;

            if(!pt && !pnt && !u) return alert("Selecciona al menos un tipo de permiso para eliminar.");
            if(!confirm("ADVERTENCIA: ¿Eliminar permanentemente las solicitudes seleccionadas?")) return;

            const typesToDelete = [];
            if(pt) typesToDelete.push('paid_teaching');
            if(pnt) typesToDelete.push('paid_non_teaching');
            if(u) typesToDelete.push('unpaid');

            const initialCount = window.app.requests.length;
            window.app.requests = window.app.requests.filter(r => !typesToDelete.includes(r.type));
            const deletedCount = initialCount - window.app.requests.length;

            cbPaidTeaching.checked = false;
            cbPaidNonTeaching.checked = false;
            cbUnpaid.checked = false;

            showNotification(`Se han eliminado ${deletedCount} solicitudes.`);
            renderCalendar(); 
            window.app.renderSummaryTable();
            window.app.renderReportTable();
        };
        
        window.app.confirmAddHoliday = () => {
            const ds = document.getElementById('input-holiday-date').value; if(!ds) return;
            const type = window.app.tempHolidayType;
            let target = '';
            if(type === 'local') target = 'localHolidays';
            else if(type === 'provincial') target = 'provHolidays';
            else if(type === 'unavailable') target = 'unavailableDays';
            else target = 'nonTeachingDays';

            if(!window.app.config[target]) window.app.config[target] = [];
            
            if(type === 'nonTeaching') {
                const de = document.getElementById('input-holiday-end-date').value;
                if(!de) return alert("Indica fin.");
                let curr = new Date(ds), end = new Date(de);
                while(curr <= end) {
                    const dStr = curr.toISOString().split('T')[0];
                    if(!window.app.config[target].includes(dStr)) window.app.config[target].push(dStr);
                    curr.setDate(curr.getDate()+1);
                }
            } else { if(!window.app.config[target].includes(ds)) window.app.config[target].push(ds); }
            window.app.config[target].sort(); window.app.closeModal('modal-holiday'); renderAll();
        };

        function renderCalendar() {
            const container = document.getElementById('calendar-grid'); container.innerHTML = '';
            const y = window.app.config.startYear;
            const months = [ {y,m:8},{y,m:9},{y,m:10},{y,m:11},{y:y+1,m:0},{y:y+1,m:1},{y:y+1,m:2},{y:y+1,m:3},{y:y+1,m:4},{y:y+1,m:5} ];
            const mNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            months.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-lg shadow border border-gray-200 overflow-hidden";
                let html = `<div class="bg-gray-100 p-2 text-center font-bold text-gray-700 border-b">${mNames[item.m]} ${item.y}</div>`;
                html += `<div class="grid grid-cols-7 text-xs text-center font-medium bg-gray-50 py-1"><div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div></div><div class="grid grid-cols-7">`;
                const dim = new Date(item.y, item.m+1, 0).getDate();
                const off = (new Date(item.y, item.m, 1).getDay() + 6) % 7;
                for(let i=0; i<off; i++) html += `<div class="bg-gray-50"></div>`;
                for(let d=1; d<=dim; d++) {
                    const dateStr = `${item.y}-${String(item.m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const day = new Date(item.y, item.m, d).getDay();
                    const isW = day===0||day===6;
                    const isL = window.app.config.localHolidays.includes(dateStr);
                    const isP = window.app.config.provHolidays.includes(dateStr);
                    const isN = (window.app.config.nonTeachingDays||[]).includes(dateStr);
                    const isU = (window.app.config.unavailableDays||[]).includes(dateStr);
                    const reqs = window.app.requests.filter(r => r.date === dateStr);
                    
                    let cls = "calendar-cell"; let num = "font-medium text-sm";
                    if(isW) { cls += " cell-weekend"; num="text-red-400"; }
                    else if(isL) { cls += " cell-local"; num="text-purple-700 font-bold"; }
                    else if(isP) { cls += " cell-prov"; num="text-orange-700 font-bold"; }
                    else if(isN) { cls += " cell-non-teaching"; num="text-yellow-700 font-bold"; }
                    else if(isU) { cls += " cell-unavailable"; num="text-gray-700 font-bold"; }
                    if(reqs.length>0) cls += " cell-active";

                    let dots = ''; let attrs = '';
                    if(reqs.length > 0) {
                        dots = '<div class="mt-1 flex gap-0.5 flex-wrap justify-center w-full px-1">';
                        const max = 3; const count = reqs.length;
                        const display = count > max ? max-1 : count;
                        for(let i=0; i<display; i++) {
                            const t = reqs[i].type;
                            let c = 'bg-gray-400';
                            if(t === 'paid_teaching') c = 'bg-blue-500';
                            if(t === 'paid_non_teaching') c = 'bg-yellow-500';
                            if(t === 'unpaid') c = 'bg-gray-700';
                            dots += `<div class="w-2 h-2 rounded-full ${c}"></div>`;
                        }
                        if(count > max) dots += `<div class="text-[9px] leading-3 font-bold text-gray-500 ml-0.5">+${count-(max-1)}</div>`;
                        dots += '</div>';
                        const tips = reqs.map(r => {
                            const tn = window.app.config.teachers.find(tx=>tx.id===r.teacherId)?.name || '??';
                            const tm = { 'paid_teaching':'Retr. Lect.', 'paid_non_teaching':'Retr. NO Lect.', 'unpaid':'No Retr.' };
                            return `• ${tn} (${tm[r.type]})`;
                        }).join('<br>').replace(/'/g, "&apos;");
                        attrs = `onmouseenter="window.app.showTooltip(event, '${tips}')" onmouseleave="window.app.hideTooltip()"`;
                    }
                    const clk = (!isW && !isL && !isP && !isU) ? `onclick="window.app.openRequestModal('${dateStr}')"` : '';
                    html += `<div class="${cls}" ${clk} ${attrs}><span class="${num}">${d}</span>${dots}</div>`;
                }
                html += `</div>`; card.innerHTML = html; container.appendChild(card);
            });
        }

        window.app.openRequestModal = (ds) => {
            window.app.selectedDate = ds;
            const isN = (window.app.config.nonTeachingDays||[]).includes(ds);
            document.getElementById('modal-request-title').innerText = `Día: ${new Date(ds).toLocaleDateString()} ${isN?'(NO LECTIVO)':''}`;
            document.getElementById('opt-paid-teaching').classList.toggle('hidden', isN);
            document.getElementById('opt-paid-non-teaching').classList.toggle('hidden', !isN);
            document.getElementById('bulk-action-container').classList.toggle('hidden', !isN);
            const sel = document.getElementById('req-teacher-select'); sel.innerHTML='<option value="">-- Selecciona --</option>';
            window.app.config.teachers.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.innerText=t.name; sel.appendChild(o); });
            const c = document.getElementById('request-list-container'); c.innerHTML='';
            const reqs = window.app.requests.filter(r=>r.date===ds);
            if(reqs.length===0) c.innerHTML='<p class="text-gray-400 text-sm italic">Ninguna.</p>';
            else {
                reqs.forEach(r=>{
                    const name = window.app.config.teachers.find(t=>t.id===r.teacherId)?.name||'??';
                    const lbl = {'paid_teaching':'Retr. Lect.','paid_non_teaching':'Retr. NO Lect.','unpaid':'No Retr.'}[r.type];
                    const cls = {'paid_teaching':'bg-blue-100 text-blue-800','paid_non_teaching':'bg-yellow-100 text-yellow-800','unpaid':'bg-gray-100 text-gray-800'}[r.type];
                    const d=document.createElement('div'); d.className="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200";
                    d.innerHTML=`<div><span class="font-bold text-sm block">${name}</span><span class="text-xs px-2 py-0.5 rounded ${cls}">${lbl}</span></div><button onclick="window.app.deleteRequest('${r.id}')" class="text-red-500 hover:text-red-700 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`;
                    c.appendChild(d);
                });
                lucide.createIcons();
            }
            document.getElementById('modal-request').classList.remove('hidden');
        };

        window.app.deleteRequest = (id) => { if(confirm('¿Anular?')) { window.app.requests=window.app.requests.filter(r=>r.id!==id); window.app.openRequestModal(window.app.selectedDate); renderCalendar(); }};

        window.app.submitRequest = () => {
            const tid = document.getElementById('req-teacher-select').value; if(!tid) return alert('Selecciona profesor');
            const type = document.querySelector('input[name="reqType"]:checked')?.value;
            if(!type) return alert('Selecciona tipo de permiso');
            const ds = window.app.selectedDate; const isN = (window.app.config.nonTeachingDays||[]).includes(ds);
            if(type==='paid_teaching' && isN) return alert('Error: Tipo lectivo en día no lectivo.');
            if(type==='paid_non_teaching' && !isN) return alert('Error: Tipo no lectivo en día lectivo.');
            if(window.app.requests.find(r=>r.date===ds && r.teacherId===tid)) return alert('Ya tiene solicitud hoy.');
            if(!isN) { if(window.app.requests.filter(r=>r.date===ds).length >= 2) return alert('Límite diario (2) alcanzado.'); }
            const treqs = window.app.requests.filter(r=>r.teacherId===tid);
            if(type==='paid_teaching' && treqs.filter(r=>r.type==='paid_teaching').length>=2) return alert('Máximo 2 Retribuidos Lectivos.');
            if(type==='paid_non_teaching' && treqs.filter(r=>r.type==='paid_non_teaching').length>=4) return alert('Máximo 4 Retribuidos No Lectivos.');
            window.app.requests.push({id:crypto.randomUUID(), date:ds, teacherId:tid, type});
            window.app.openRequestModal(ds); renderCalendar();
        };

        window.app.submitBulkRequest = () => {
            if(!confirm('¿Añadir a todo el claustro disponible?')) return;
            const ds = window.app.selectedDate; const type = document.querySelector('input[name="reqType"]:checked')?.value;
            if(!type) return alert('Selecciona tipo');
            let add=0; 
            window.app.config.teachers.forEach(t => {
                if(window.app.requests.find(r=>r.date===ds && r.teacherId===t.id)) return;
                const treqs = window.app.requests.filter(r=>r.teacherId===t.id);
                if(type==='paid_non_teaching' && treqs.filter(r=>r.type==='paid_non_teaching').length>=4) return;
                window.app.requests.push({id:crypto.randomUUID(), date:ds, teacherId:t.id, type}); add++;
            });
            window.app.openRequestModal(ds); renderCalendar(); showNotification(`Añadidos: ${add}`);
        };

        function renderSummaryTable() {
            const tb=document.getElementById('table-summary-body'); tb.innerHTML='';
            const teachersSorted = [...window.app.config.teachers].sort((a,b) => a.name.localeCompare(b.name));
            const filterElement = document.querySelector('input[name="filter-summary"]:checked');
            const filterValue = filterElement ? filterElement.value : 'all';

            if(teachersSorted.length === 0) { tb.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Sin datos.</td></tr>'; return; }
            
            teachersSorted.forEach(t => {
                const rs = window.app.requests.filter(r => r.teacherId === t.id);
                const pt = rs.filter(r => r.type === 'paid_teaching').length;
                const pnt = rs.filter(r => r.type === 'paid_non_teaching').length;
                const u = rs.filter(r => r.type === 'unpaid').length;
                const totalRequests = pt + pnt + u;
                if (filterValue === 'active' && totalRequests === 0) return;

                let statusHtml = '<span class="text-green-600 font-bold">Disponible</span>';
                if (pt >= 2 && pnt >= 4) { statusHtml = '<span class="text-red-600 font-bold">AGOTADO</span>'; } 
                else if (pt >= 2) { statusHtml = '<span class="text-orange-500 font-bold">Solo No Lect.</span>'; } 
                else if (pnt >= 4) { statusHtml = '<span class="text-orange-500 font-bold">Solo Lect.</span>'; }
                
                const tr = document.createElement('tr'); 
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `<td class="p-3 font-medium whitespace-nowrap">${t.name}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded ${pt>=2?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700'}">${pt} / 2</span></td><td class="p-3 text-center"><span class="px-2 py-1 rounded ${pnt>=4?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}">${pnt} / 4</span></td><td class="p-3 text-center"><span class="px-2 py-1 rounded bg-gray-100 text-gray-700">${u}</span></td><td class="p-3 text-center text-sm whitespace-nowrap">${statusHtml}</td>`;
                tb.appendChild(tr);
            });
            
            if (tb.innerHTML === '') tb.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400 italic">No hay profesores con permisos solicitados.</td></tr>';
        };

        window.app.renderReportTable = () => {
            const s=document.getElementById('report-start').value; const e=document.getElementById('report-end').value;
            const tb=document.getElementById('table-report-body');
            if(!s||!e) return;
            const res = window.app.requests.filter(r=>r.date>=s && r.date<=e).sort((a,b)=>a.date.localeCompare(b.date));
            document.getElementById('report-count').innerText = res.length; tb.innerHTML='';
            if(res.length===0) tb.innerHTML='<tr><td colspan="3" class="p-6 text-center text-gray-500">Sin datos.</td></tr>';
            res.forEach(r=>{
                const n=window.app.config.teachers.find(t=>t.id===r.teacherId)?.name||'??';
                const l={'paid_teaching':'Retr. Lect.','paid_non_teaching':'Retr. NO Lect.','unpaid':'No Retr.'}[r.type];
                const tr=document.createElement('tr'); tr.className="border-b hover:bg-gray-50";
                tr.innerHTML=`<td class="p-3 whitespace-nowrap">${new Date(r.date).toLocaleDateString()}</td><td class="p-3 font-medium whitespace-nowrap">${n}</td><td class="p-3 whitespace-nowrap">${l}</td>`;
                tb.appendChild(tr);
            });
        };

        init();
    </script>
	<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // Aseguramos que cargamos la última versión del SW
            navigator.serviceWorker.register('./sw.js?v=2')
                .then(reg => console.log('PWA Lista', reg))
                .catch(err => console.log('Error PWA', err));
        });
    }
</script>
</body>
</html>